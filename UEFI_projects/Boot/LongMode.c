#include <Uefi.h>
#include <Library/UefiLib.h>
#include <Library/UefiApplicationEntryPoint.h>

extern EFI_BOOT_SERVICES *gBS;



char init[] = "\x66\x31\xc0\x66\xb8\xea\x00\x01\x00\x67\x66\xa3\xe4\x00\x01\x00"
"\x66\xb8\xf8\x00\x01\x00\x67\x66\xa3\x22\x01\x01\x00\x67\x66\x0f"
"\x01\x15\x20\x01\x01\x00\xe4\x92\x0c\x02\xe6\x92\xfa\xe4\x70\x0c"
"\x80\xe6\x70\x0f\x20\xc0\x0c\x01\x0f\x22\xc0\x67\x66\xff\x2d\x43"
"\x00\x01\x00\x49\x00\x01\x00\x18\x00\x66\xb8\x20\x00\x8e\xd8\x66"
"\xb8\x10\x00\x8e\xc0\xbc\x00\x00\x20\x00\x0f\x20\xe0\x83\xc8\x20"
"\x0f\x22\xe0\xbf\x00\x00\x17\x00\xb9\x00\x10\x00\x00\x31\xc0\xf3"
"\xab\xbf\x00\x00\x17\x00\x26\xc7\x07\x07\x10\x17\x00\xbf\x00\x10"
"\x17\x00\xb9\x02\x00\x00\x00\xb8\x07\x20\x17\x00\xab\x26\xc7\x07"
"\x00\x00\x00\x00\x83\xc7\x04\x05\x00\x10\x00\x00\xe2\xee\xbf\x00"
"\x20\x17\x00\xb9\x00\x04\x00\x00\xb8\x87\x00\x00\x00\xab\x26\xc7"
"\x07\x00\x00\x00\x00\x83\xc7\x04\x05\x00\x00\x20\x00\xb8\x00\x00"
"\x17\x00\x0f\x22\xd8\xb9\x80\x00\x00\xc0\x0f\x32\x0d\x00\x01\x00"
"\x00\x0f\x30\x0f\x20\xc0\x0d\x00\x00\x00\x80\x0f\x22\xc0\xff\x2d"
"\xe4\x00\x01\x00\x00\x00\x00\x00\x08\x00\x48\xc7\xc2\x00\x03\x00"
"\x00\x66\xff\x02\xeb\xfb\x90\x90\x00\x00\x00\x00\x00\x00\x00\x00"
"\xff\xff\x00\x00\x00\x9a\xaf\x00\xff\xff\x00\x00\x00\x92\xcf\x00"
"\xff\xff\x00\x00\x00\x9a\xcf\x00\xff\xff\x00\x00\x00\x92\xcf\x00"
"\x27\x00"

// char lgdt[] = "";
// char c_code[] = "";
// char gdt[] = "\x00\x00\x00\x00\x00\x00\x00\x00" // 0
// 			 "\xff\xff\x00\x00\x00\x9a\xaf\x00" // LM_code
// 			 "\xff\xff\x00\x00\x00\x92\xcf\x00" // LM_data
// 			 "\xff\xff\x00\x00\x00\x9a\xcf\x00" // PM_code
// 			 "\xff\xff\x00\x00\x00\x92\xcf\x00";// PM_data

EFI_STATUS
EFIAPI
UefiMain (IN EFI_HANDLE ImageHandle, IN EFI_SYSTEM_TABLE *SystemTable)
{
	UINT8* init_entry = (void*) 0x10000;
	// uint8_t* lgdt_entry = init_entry + sizeof(init); //  8000h
	// uint8_t* c_entry = NULL;
	// uint8_t* gdt_entry = NULL;
	// uint8_t* pml4_entry = NULL;
	// Возможно придется получить информацию о процессорах
	UINT8 apic_id = 1;

	Print(L"Programm start!\n");

	// TODO: Выделить память для c_entry size: c_code + gdt + pml4
	//
	//
	//
	//
	//

	// gdt_entry = c_entry + sizeof(c_code);
	// pml4_entry = gdt_entry + sizeof(gdt);

	gBS->CopyMem(init_entry, init, sizeof(init));
	// gBS->CopyMem(lgdt_entry, lgdt, sizeof(lgdt));
	// gBs->CopyMem(c_entry, c_code, sizeof(c_code));
	// gBS->CopyMem(gdt_entry, gdt, sizeof(gdt));

	// TODO: Сформировать PML4
	//
	//
	//
	//
	//

	// *(lgdt_entry - 4) = c_entry;
	// *(lgdt_entry - 8) =  pml4_entry;
	// *(lgdt_entry - 16) = gdt_entry;

	UINT32* APIC_ERROR = (void*) 0xfee00280;
	UINT32* APIC_ICR_LOW = (void*) 0xfee00300;
	UINT32* APIC_ICR_HIG = (void*) 0xfee00310;

	// INIT
	*APIC_ERROR = 0;
	*APIC_ICR_HIG = (UINT32) apic_id << 24;
	*APIC_ICR_LOW = 0x00000500;

	for(volatile unsigned i = 0; i < 0xffffff; ++i) ;  // Задержка

	// SIPI
	*APIC_ERROR = 0;
	*APIC_ICR_LOW = ((UINT32) 0x00000600 | ((UINT32) 0x00010000 >> 12));
	
	Print(L"Progamm end!\n");
	
    return EFI_SUCCESS;
}
